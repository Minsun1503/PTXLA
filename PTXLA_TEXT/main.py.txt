import os
import json
import sys

# Import project modules
from src import config
from src import pre_processing
from src import measure_tool
from src import omr_logic
from src import ocr_logic
from src import ui


def run_grading_process(answer_block_anchors, ocr_regions, warped_image, outside_image):
    """
    Orchestrates the full grading process, including OMR and OCR.

    Args:
        answer_block_anchors (list): A list containing the two anchor coordinates.
        ocr_regions (dict): A dictionary of named regions for OCR.
        warped_image (numpy.ndarray): The processed, perspective-corrected image of the sheet.
        outside_image (numpy.ndarray): The image containing the area outside the main document.
    """
    if warped_image is None:
        print("--> LỖI: Không có ảnh để xử lý.")
        return

    # --- OMR Section ---
    if answer_block_anchors:
        print("--- Bắt đầu chấm điểm trắc nghiệm (OMR) ---")
        # 1. Generate OMR coordinates
        answer_coords = omr_logic.generate_column_coordinates(
            start_point=answer_block_anchors[0],
            end_point=answer_block_anchors[1],
            num_questions=config.NUM_QUESTIONS_PER_COLUMN,
            num_choices=config.NUM_CHOICES_PER_QUESTION
        )
        all_coords = [answer_coords]

        # 2. Grade the bubbles
        student_answers, _ = omr_logic.grade_with_coordinates(warped_image, all_coords)
        correct_answers = omr_logic.load_answer_key(config.ANSWER_KEY_PATH)

        if not correct_answers:
            print("Cảnh báo: Không tìm thấy hoặc file đáp án trống!")
            final_score, num_correct, results = 0, 0, [False] * len(student_answers)
        else:
            final_score, num_correct, results = omr_logic.calculate_score(student_answers, correct_answers)
            print("\n==========================")
            print(f"   KẾT QUẢ OMR: {final_score:.2f} / 10")
            print(f"   Số câu đúng: {num_correct} / {len(correct_answers)}")
            print("==========================\n")
        
        # 3. Draw OMR results on the image
        result_image = ui.draw_results_on_image(warped_image, student_answers, correct_answers, results, all_coords)
        score_image = ui.create_score_display(final_score, num_correct, len(correct_answers))
    else:
        print("--> Không có tọa độ trắc nghiệm, bỏ qua phần chấm OMR.")
        result_image = warped_image.copy()
        score_image = ui.create_score_display(0, 0, 0)

    # --- OCR Section ---
    # Perform OCR on the 'outside_image' since the ROIs were detected there.
    ocr_data = ocr_logic.extract_text_from_regions(outside_image, ocr_regions)

    # --- Finalization ---
    # 5. Save all output files, now including the outside_image
    ui.save_output_files(result_image, score_image, ocr_data, outside_image)

    # 6. Show the results on screen
    ui.show_final_results(result_image, score_image, ocr_data)


if __name__ == "__main__":
    """
    Main entry point of the application.
    Handles initial setup of coordinates/ROIs and then runs the grading process.
    """
    if not os.path.exists(config.OUTPUT_PATH):
        os.makedirs(config.OUTPUT_PATH)

    anchors = []
    regions = {}
    warped_img = None
    outside_img = None  # Initialize outside_img

    # Check if coordinates have been configured previously
    if not os.path.exists(config.COORDINATES_PATH):
        if ui.prompt_coordinate_setup():
            # The tool now returns the outside_image as well
            anchors, regions, warped_img, outside_img = measure_tool.get_coordinates_and_rois(
                pdf_path=config.PDF_PATH,
                coord_save_path=config.COORDINATES_PATH
            )
            if len(anchors) < 2:
                print("Lỗi: Cần chọn đủ 2 tọa độ cho khối đáp án. Vui lòng chạy lại.")
                sys.exit()
        else:
            print("Chương trình không thể tiếp tục nếu không có tọa độ. Đang thoát...")
            sys.exit()
    else:
        print(f"--> Đã tìm thấy file tọa độ tại: {config.COORDINATES_PATH}")
        try:
            with open(config.COORDINATES_PATH, 'r') as f:
                data = json.load(f)
            anchors = data.get("bubble_anchors", [])
            regions = data.get("ocr_regions", {})
            if not anchors:
                raise ValueError("File tọa độ không hợp lệ: thiếu 'bubble_anchors'.")
        except (json.JSONDecodeError, ValueError) as e:
            print(f"Lỗi đọc file tọa độ: {e}")
            print("Vui lòng xóa file 'output/coordinates.json' và chạy lại để thiết lập từ đầu.")
            sys.exit()
        
        # Process the PDF to get both the warped image and the outside area
        print("--> Đang tải và xử lý ảnh từ PDF...")
        # The function now returns two images
        warped_img, outside_img = pre_processing.get_warped_image_from_pdf(config.PDF_PATH, config.STANDARD_SIZE)

    # With coordinates and images ready, run the main grading process
    run_grading_process(anchors, regions, warped_img, outside_img)
